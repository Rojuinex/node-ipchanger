// Generated by CoffeeScript 1.6.2
(function() {
  var ProxyServer, getServers, http, jsdom, mongoose, nodeTor, proxy, qs, server, util;

  http = require('http');

  proxy = require('http-proxy');

  nodeTor = require('../node_modules/node-Tor/lib/node-tor.js');

  qs = require('querystring');

  jsdom = require('jsdom');

  util = require('util');

  mongoose = require('mongoose');

  mongoose.connect('mongodb://localhost/ipchanger');

  ProxyServer = mongoose.model('ProxyServer', {
    'Last-Update': String,
    'ipaddress': String,
    'port': String,
    'country': String
  });

  getServers = function(body, req, res) {
    return jsdom.env({
      html: body,
      scripts: ['http://code.jquery.com/jquery-1.5.min.js']
    }, function(err, window) {
      var $, $rows, $table, $thead;

      $ = window.jQuery;
      res.writeHead(200, {
        'Content-Type': 'text/plain',
        'Connection': 'keep-alive',
        'Transfer-Encoding': 'chunked'
      });
      console.log('Starting to scrape\n');
      console.log('Removing bad elements...');
      $('div,span', 'table#listtable').filter(function() {
        if (($(this).css('display') === 'none') || ($(this).html() === "")) {
          return true;
        } else {
          return false;
        }
      }).remove();
      console.log('Removing Style');
      $('style').remove();
      $table = $('table#listtable');
      $thead = $table.find('thead');
      $rows = $('table#listtable>tr');
      console.log('Parsing rows');
      return $rows.each(function(i) {
        var $dataCells, $row;

        if (i > 0) {
          res.write("\n");
        }
        console.log("Proxy Server " + i + "\n---------------------------");
        res.write("Proxy Server " + i + "\n---------------------------\n");
        $row = $(this);
        $dataCells = $row.children('td');
        return $dataCells.each(function(j) {
          var $cell;

          $cell = $(this);
          if (/[0-9a-bA-B].+/.test($cell.text())) {
            console.log($.trim($cell.text()));
            res.write($.trim($cell.text()) + "\n");
          }
          if (j + 1 === $dataCells.length && i + 1 === $rows.length) {
            return res.end("********************* FINISHED *********************");
          }
        });
      });
    });
  };

  server = http.createServer(function(req, res) {
    req.on('data', function(data) {});
    return req.on('end', function() {
      var hmareq, options, postData;

      postData = qs.stringify({
        'c[]': ['United States', 'Canada'],
        'p': '',
        'pr[]': ['0', '1'],
        'a[]': ['2', '3', '4'],
        'pl': 'on',
        'sp[]': ['2', '3'],
        'ct[]': ['2', '3'],
        's': '1',
        'o': '0',
        'pp': '3',
        'sortBy': 'response_time'
      });
      options = {
        hostname: "hidemyass.com",
        port: 80,
        path: "/proxy-list/",
        method: "POST",
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'Content-Length': postData.length,
          'User-Agent': 'Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:20.0) Gecko/20100101 Firefox/20.0',
          'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
          'Accept-Language': 'en-US,en;q=0.5',
          'Referer': 'http://hidemyass.com/proxy-list/',
          'Connection': 'keep-alive',
          'Cookie': 'PHPSESSID=sq6lgj469plc2kk1mjr5s0i1e2; __utma=82459535.930825937.1369329500.1369329500.1369329500.1; __utmb=82459535.2.10.1369329500; __utmc=82459535; __utmz=82459535.1369329500.1.1.utmcsr=(direct)|utmccn=(direct)|utmcmd=(none)'
        }
      };
      hmareq = http.request(options, function(hmares) {
        var body;

        body = '';
        hmares.on('data', function(data) {
          return body += data;
        });
        return hmares.on('end', function() {
          var hmareq2, options2, postData2;

          postData2 = "q=378";
          options2 = {
            hostname: "hidemyass.com",
            port: 80,
            path: hmares.headers['location'],
            method: "POST",
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'Content-Length': postData2.length,
              'User-Agent': 'Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:20.0) Gecko/20100101 Firefox/20.0',
              'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
              'Accept-Language': 'en-US,en;q=0.5',
              'Referer': 'http://hidemyass.com/proxy-list/',
              'Connection': 'keep-alive',
              'Cookie': 'PHPSESSID=sq6lgj469plc2kk1mjr5s0i1e2; __utma=82459535.930825937.1369329500.1369329500.1369329500.1; __utmb=82459535.2.10.1369329500; __utmc=82459535; __utmz=82459535.1369329500.1.1.utmcsr=(direct)|utmccn=(direct)|utmcmd=(none)'
            }
          };
          hmareq2 = http.request(options2, function(hmares2) {
            var body2;

            body2 = '';
            hmares2.on('data', function(data) {
              return body2 += data;
            });
            return hmares2.on('end', function() {
              return getServers(body2, req, res);
            });
          });
          hmareq2.write(postData2);
          return hmareq2.end();
        });
      });
      hmareq.on('error', function(e) {
        return console.log('Problem with request: ' + e.message);
      });
      hmareq.write(postData);
      return hmareq.end();
    });
  });

  server.listen(8088);

}).call(this);
